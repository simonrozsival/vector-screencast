/**
 * Khanova Škola - vektorové video
 *
 * [@todo project anotation]
 * 
 * @author:		Šimon Rozsíval (simon@rozsival.com)
 * @project:	Vector screencast for Khan Academy (Bachelor thesis)
 * @repository: http://github.com/rozsival/vector-video
 * @license:	MIT
 */

var AudioRecorder=function(navigator,window){var _this;var context;var input;var recording=false;var recordingWorkerPath="/js/workers/recording-worker.js";var recordingWorker=null;var initSuccessful=false;var doNotStartRecording=false;var settings={port:3e3,host:"http://localhost",path:"/upload/audio",error:function(){console.log("Error arguments: ",arguments)}};function AudioRecorder(config){$.extend(true,settings,config);recording=false;_this=this}AudioRecorder.prototype.init=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;context=new AudioContext;console.log("Audio context is set up.");window.URL=window.URL||window.webkitURL;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia){navigator.getUserMedia({video:false,audio:true},function(localMediaStream){if(doNotStartRecording===false){input=context.createMediaStreamSource(localMediaStream);console.log("Created media stream.");console.log("Input sample rate: "+input.context.sampleRate);var bufferSize=2048;var recorder=context.createScriptProcessor(bufferSize,1,1);recorder.onaudioprocess=processData;input.connect(recorder);recorder.connect(context.destination);initSuccessful=true;_this.createAudioProcessor("web-socket",{port:settings.port||4e3,host:settings.host||"localhost",path:settings.path||"/",success:function(){console.log("Audio recording is ready.")},error:function(msg){console.log(msg)}});if(settings.hasOwnProperty("success")){settings.success()}VideoEvents.trigger("register-tool","audio-recorder")}},function(err){if(err.name==="PermissionDeniedError"){console.log("User didn't allow microphone usage.")}console.log("Can't record audio",err);settings.error({code:0,message:"Can't record audio"})})}else{console.log("getUserMedia not supported by the browser");settings.error({code:0,message:"getUserMedia not supported by the browser"})}};AudioRecorder.prototype.createAudioProcessor=function(AudioProcessorType,cfg){if(Worker){recordingWorker=new Worker(recordingWorkerPath);recordingWorker.postMessage({cmd:"init",AudioProcessorType:AudioProcessorType||"web-sockets",port:cfg.port,host:cfg.host,path:cfg.path});if(cfg.hasOwnProperty("success")){cfg.success()}}else{console.log("ERROR - no workers support - non supported browser.");alert("Your browser doesn't support Web Workers technology, audio can't be recorded.")}};AudioRecorder.prototype.start=function(cfg){cfg=cfg||{};if(initSuccessful){if(!recordingWorker){if(cfg&&cfg.hasOwnProperty("error")){cfg.error({code:1,message:"No audio processor was set."})}return false}else{recording=true;return true}}else{doNotStartRecording=true;return false}};AudioRecorder.prototype.continue=function(cfg){cfg=cfg||{};if(initSuccessful){if(!recordingWorker){if(cfg&&cfg.hasOwnProperty("error")){cfg.error({code:1,message:"No audio processor was set."})}return false}else{recording=true;return true}}else{}return false};AudioRecorder.prototype.pause=function(cfg){cfg=cfg||{};if(initSuccessful){recording=false;return true}else{}return false};AudioRecorder.prototype.stop=function(cfg){cfg=cfg||{};if(initSuccessful){if(this.pause(cfg)){var oldSuccess=cfg.success||undefined;cfg.success=function(data){if(oldSuccess){oldSuccess(data)}VideoEvents.trigger("tool-finished","audio-recorder")};if(recordingWorker){recordingWorker.onmessage=function(e){var msg=e.data;if(!msg.hasOwnProperty("error")){console.log("Worker response is invalid (missing property 'error'",e.data);return}if(msg.error===true&&cfg.hasOwnProperty("error")){cfg.error({message:msg.message})}else if(msg.error===false&&cfg.hasOwnProperty("success")){cfg.success(msg.fileName)}};recordingWorker.postMessage({cmd:"finish"})}}}else{if(cfg.hasOwnProperty("error")){cfg.error()}}};AudioRecorder.prototype.isRecording=function(){return initSuccessful};var processData=function(data){if(recording===false){return}var left=data.inputBuffer.getChannelData(0);if(recordingWorker){recordingWorker.postMessage({cmd:"pushData",data:left})}};return AudioRecorder}(navigator,window);var AudioPlayer=function(){var playing,reachedEnd;var audio;var initSuccessful;function AudioPlayer(sources,events){audio=HTML.createElement("audio",{preload:"auto"});initSuccessful=false;if(audio.canPlayType==undefined){console.log("ERROR: browser does not support HTML5 audio");return}audio.autoplay=false;playing=false;reachedEnd=false;var canPlaySound=false;for(var source in sources){var contentType="audio/"+sources[source].type;if(!!audio.canPlayType(contentType)){var source=HTML.createElement("source",{type:contentType,src:sources[source].file});audio.appendChild($source);canPlaySound=true}}if(canPlaySound==true){initSuccessful=true;attachPrivateEvents.call(this);attachEvents.call(this,events);$("body").append($audio);console.log("Audio is available.")}else{console.log("Can't play any provided audio sources.")}}AudioPlayer.prototype.isReady=function(){return initSuccessful};var attachPrivateEvents=function(){audio.onended=function(){playing=false;reachedEnd=true;console.log("(audio reached end)")};audio.onpause=function(){if(playing){VideoEvents.trigger("pause")}};audio.ontimeupdate=function(e){reportCurrentTime()};VideoEvents.on("start",function(){play()});VideoEvents.on("pause",function(){pause()});VideoEvents.on("reached-end",function(){reachedEnd=true;pause()});VideoEvents.on("replay",function(){rewind();play()});VideoEvents.on("skip-to",function(e,progress){reachedEnd=false;changePosition(audio.duration*progress)});var lastEnd=null;var checkPreloaded=setInterval(function(){if(audio.canPlayThrough){clearInterval(checkPreloaded)}else{var end=audio.buffered.end(audio.buffered.length-1);if(end!==lastEnd){VideoEvents.trigger("buffered-until",end);lastEnd=end}}},1e3)};var attachEvents=function(events){events=events||[];for(var eventName in events){$audio.on(eventName,events[eventName])}};var play=function(){if(initSuccessful){if(reachedEnd==true){rewind()}audio.play()}};var pause=function(){if(initSuccessful){audio.pause()}};var rewind=function(){if(initSuccessful){audio.pause();audio.currentTime=0;reachedEnd=false}};var changePosition=function(seconds,callback){console.log("audio - change position to "+seconds+"s");audio.currentTime=seconds;$audio.on("canplay",callback)};var reportCurrentTime=function(){VideoEvents.trigger("current-time",$audio[0].currentTime)};return AudioPlayer}();var UserInputDataProvider=function(){var state={running:false,mouseDown:false};var offset;var cursor={x:0,y:0};var timer;var penApi=false;var lastState;function UserInputDataProvider(){document.onmousemove=function(e){onMouseMove(e)};document.onmousedown=function(e){onMouseDown(e)};document.onmouseup=function(e){onMouseUp(e)};window.onblur=function(e){onMouseUp(e)};init()}var getCurrentCursorState=function(){return new State({x:cursor.x,y:cursor.y,pressure:getPressure(),time:timer.currentTime()})};var getPressure=function(){if(penApi&&penApi.pointerType==1){return penApi.pressure}else{return state.mouseDown?1:0}};var correctMouseCoords=function(e){if(e.pageX==undefined||e.pageY==undefined){console.log("Wrong 'correctMouseCoords' parameter. Event data required.")}return{x:e.pageX-offset.left,y:e.pageY-offset.top}};var init=function(){timer=new VideoTimer;VideoEvents.on("canvas-container-ready",function(e,canvasContainer){var rect=canvasContainer.getBoundingClientRect();offset={top:rect.top,left:rect.left}});VideoEvents.on("start",start);VideoEvents.on("continue",start);VideoEvents.on("pause",pause);VideoEvents.on("stop",pause);VideoEvents.on("wacom-plugin-ready",function(e,plugin){console.log("Wacom plugin: ",plugin.version);if(!!plugin===true&&!!plugin.version===true){console.log("Wacom tablet is connected and plugin installed. Plugin version is "+plugin.version+".");penApi=plugin.penAPI}})};var start=function(){state.running=true;timer.resetTimer()};var pause=function(){state.running=false};var reportAction=function(action){if(action!=undefined){VideoEvents.trigger("new-state",action)}};var onMouseMove=function(e){if(state.running){cursor=correctMouseCoords.call(this,e);var current=getCurrentCursorState();reportAction(current);lastState=current}};var onMouseDown=function(e){if(state.running){state.mouseDown=true;reportAction(getCurrentCursorState())}};var onMouseUp=function(e){if(state.running){state.mouseDown=false;reportAction(getCurrentCursorState())}};return UserInputDataProvider}();var XmlDataProvider=function(){var videoInfo;var correctionRatio;var state={running:false,reachedEnd:false,current:undefined,last:undefined};var startTime;var timeout;function XmlDataProvider(fileName){var _this=this;videoInfo=new XmlReader({file:fileName,success:function(){initEvents.call(_this);VideoEvents.trigger("data-ready",getInfo());rewind()},error:function(msg){videoInfo=null;VideoEvents.trigger("error",msg)}});state.running=false}XmlDataProvider.prototype.getTitle=function(){if(videoInfo){return videoInfo.getInfo().about.title}return null};XmlDataProvider.prototype.getAuthor=function(){if(videoInfo){return videoInfo.getInfo().about.author}return null};XmlDataProvider.prototype.getDescription=function(){if(videoInfo){return videoInfo.getInfo().about.description}return null};XmlDataProvider.prototype.getAudioSources=function(){if(videoInfo){var sources=[];var audio=videoInfo.getInfo().about.audio;for(var i in audio){sources.push({file:audio[i],type:getType(audio[i])})}return sources}return null};var getType=function(fileName){return fileName.substr(fileName.length-3)};var initEvents=function(){VideoEvents.on("board-dimensions",function(e,size){correctionRatio=size.width/getInfo().board.width;VideoEvents.trigger("new-board-correction-ratio",correctionRatio)});VideoEvents.on("start",start);VideoEvents.on("continue",start);VideoEvents.on("pause",stop);VideoEvents.on("stop",stop);VideoEvents.on("rewind",rewind);var _this=this;VideoEvents.on("skip-to",function(e,progress){var time=progress*getInfo().length;if(time>state.current.time){skipForward.call(_this,time)}else{skipBackwards.call(_this,time)}})};var getNextCursorState=function(){var next=videoInfo.getNext();while(next!=undefined&&next.type!="cursor-movement"){switch(next.type){case"color-change":console.log("Change color to ",next.color);VideoEvents.trigger("color-change",next.color);break;case"brush-size-change":VideoEvents.trigger("brush-size-change",next.size);break}next=videoInfo.getNext()}if(next==undefined){next={time:getInfo().length,x:-1,y:-1,pressure:0};state.reachedEnd=true;stop()}state.last=state.current;state.current=correctCoords(next);return state.current};var correctCoords=function(state){return{x:state.x*correctionRatio,y:state.y*correctionRatio,pressure:state.pressure,time:state.time}};var getInfo=function(){return videoInfo.getInfo()};var rewind=function(){state.last={time:0};state.current=videoInfo.getNext();state.reachedEnd=false};var start=function(){startTime=Date.now();startTime-=state.last.time;state.running=true;tick()};var skipForward=function(time){tickUntil.call(this,time)};var skipBackwards=function(time){VideoEvents.trigger("rewind");tickUntil.call(this,time)};var tickUntil=function(time){getNextCursorState();while(state.current.time<time){VideoEvents.trigger("new-state",state.current);getNextCursorState()}};var debt=0;var tick=function(){getNextCursorState();while(state.running){VideoEvents.trigger("next-state-peek",state.current);var timeGap=state.current.time-(Date.now()-startTime)-debt;debt=0;if(timeGap>0){timeout=setTimeout(function(){VideoEvents.trigger("new-state",state.current);tick()},timeGap)}else{debt=timeGap;console.log("debt: ",debt);tick()}}};var stop=function(){clearTimeout(timeout);if(state.running==true){state.running=false;if(state.reachedEnd==true){VideoEvents.trigger("reached-end")}}};return XmlDataProvider}();var SVGDrawer=function(){var paper;var start=null;var end=null;var lastState;var nextRadius;var prevPoint;var lastDrawnPosition;var lastDrawnRadius;var endDot;var isOnlyClick=false;var settings;var paths={top:"",bottom:""};var path;function SVGDrawer(settingsObject){settings=settingsObject;VideoEvents.on("canvas-container-ready",prepareCanvas);VideoEvents.on("new-state",processNewState)}var prepareCanvas=function(e,container){paper=SVG.createElement("svg",{width:container.offsetWidth,height:container.offsetHeight});container.appendChild(paper)};var processNewState=function(e,state){var nextPoint=new Vector2(state.x,state.y);if(state.pressure>0){if(!lastState||lastState.pressure===0){startLine(nextPoint,state.pressure)}else{continueLine(nextPoint,state.pressure)}}else if(lastState&&lastState.pressure>0){endLine(nextPoint)}lastState=state};var startLine=function(point,pressure){isOnlyClick=true;var radius=calculateRadius(pressure);var dot=SVG.dot(point,radius,current().color);paper.appendChild(dot);prevPoint=point.clone();start=point.clone();nextRadius=radius;lastDrawnPosition=point.clone();lastDrawnRadius=radius};var continueLine=function(nextPoint,pressure){var radius=calculateRadius(pressure);if(isOnlyClick){if(preparePath(nextPoint)){end=nextPoint.clone();isOnlyClick=false;endDot=SVG.dot(end,radius,current().color);paper.appendChild(endDot)}}else{drawSegment(nextPoint,radius,false)}};var calculateRadius=function(pressure){return pressure*current().brushSize/2};var current=function(){return settings.getCurrentSettings()};var preparePath=function(nextPoint){var direction=nextPoint.subtract(start);if(direction.getX()===0&&direction.getY()===0){return false}var normal=getScaledNormal(direction,lastDrawnRadius);path=SVG.createElement("path",{fill:current().color,stroke:"transparent"});paper.appendChild(path);paths.top="M "+(start.getX()+normal.getX())+","+(start.getY()+normal.getY())+" ";paths.bottom="L "+(start.getX()-normal.getX())+","+(start.getY()-normal.getY())+" Z";return true};var drawSegment=function(nextPoint,radius,closePath){var tmp=nextRadius;nextRadius=radius;radius=tmp;var direction=end.subtract(start);var normal=getScaledNormal(direction,radius);if(normal===null){return}if(direction.getSize()>radius){drawCurvedSegment(nextPoint,normal)}else{drawStraightSegment(normal)}var cap;if(closePath!==true){cap=SVG.lineToString(nextPoint.add(normal))+" "+SVG.lineToString(nextPoint.subtract(normal));moveEndDot(nextPoint,radius)}else{cap=SVG.lineToString(end.subtract(normal));moveEndDot(end,radius)}SVG.setAttributes(path,{d:paths.top+cap+paths.bottom});lastDrawnPosition=start;lastDrawnRadius=radius;prevPoint=start.clone();start=end.clone();end=nextPoint.clone()};var drawCurvedSegment=function(nextPoint,normal){var spline=calculateSpline(prevPoint,start,end,nextPoint,normal);if(spline!==false){paths.top+=" "+SVG.curveToString(spline.top.startCP,spline.top.endCP,spline.top.end);paths.bottom=SVG.curveToString(spline.bottom.endCP,spline.bottom.startCP,spline.bottom.start)+" "+paths.bottom}else{return}};var drawStraightSegment=function(normal){paths.top+=" "+SVG.lineToString(end.add(normal));paths.bottom=SVG.lineToString(start.subtract(normal))+" "+paths.bottom};var getScaledNormal=function(direction,radius){try{return direction.getNormal().scale(radius)}catch(Exception){return new Vector2(0,0)}};var calculateSpline=function(a,b,c,d,n){var cp=SplineHelper.catmullRomToBezier(a,b,c,d);return{top:{start:cp.start.add(n),startCP:cp.startCP.add(n),end:cp.end.add(n),endCP:cp.endCP.add(n)},bottom:{start:cp.start.subtract(n),startCP:cp.startCP.subtract(n),end:cp.end.subtract(n),endCP:cp.endCP.subtract(n)}}};var endLine=function(pos){if(!isOnlyClick){var _end=end;drawSegment(pos,0,true);var lastRadius=calculateRadius(lastState.pressure);moveEndDot(_end,lastRadius)}};var moveEndDot=function(center,radius){SVG.setAttributes(endDot,{cx:center.getX(),cy:center.getY(),r:radius})};return SVGDrawer}();var XmlReader=function(){var info;var chunks=[];var currentChunk,currentStep;var loadedSuccessfully=false;function XmlReader(opts){VideoEvents.on("rewind",function(){rewind()});loadFile(opts,function(){rewind()})}var loadFile=function(opts,callback){var reportError=console.log;if(opts.hasOwnProperty("error")&&typeof opts.error=="function"){var reportError=opts.error}$.ajax({type:"GET",url:opts.file,dataType:"xml",success:function(data){var $xml=$(data);if($xml.length==0){console.log("Document is not a well-formed XML document and the video can't be loaded nor played.");return null}if(checkVersion($xml)){if(loadData($xml)){console.log("Data was loaded successfully.");loadedSuccessfully=true;callback.call();if(opts.hasOwnProperty("success")&&typeof opts.success=="function"){opts.success.call()}}else{console.log("Could not load data from a valid document.");if(typeof reportError=="function"){reportError("An error occured while loading data.")}}}else{console.log("Document is not valid or the version of the document is unsupported.");if(typeof reportError=="function"){reportError("Could not open this document. It is damaged or the version of the document is not supported.")}}},fail:function(){console.log("Retrieving the file failed.");if(typeof reportError=="function"){reportError("Could not open the document.")}}})};XmlReader.prototype.isLoaded=function(){return loadedSuccessfully===true};var supportedVersion=function(){return"dev"};var checkVersion=function($xml){var attr=$xml.find("animation").attr("version");return attr==supportedVersion()};var xsdFile=function(){return"/xml/khan-academy/vector-video.xsd"};var validateXmlDocument=function(rawXml,validationFunction){if(typeof validationFunction=="function"){if(!validationFunction(rawXml,xsdFile())){console.log("Validation against an XSD document was requested and it failed.");return false}}return true};XmlReader.prototype.getInfo=function(){return info};var loadData=function($xml){var search=function(parent){var data={};parent.children().each(function(){var child=$(this);data[this.tagName]=child.children().length>0?search(child):child.text()});return data};info=search($xml.find("info"));$xml.find("chunk").each(function(){var chunk=$(this);var data={start:chunk.attr("start"),currentColor:chunk.attr("current-color"),currentBrushSize:chunk.attr("current-brush-size"),cursor:[],prerendered:chunk.children("svg")};chunk.children("cursor").children().each(function(){var tagName=this.tagName;var item=$(this);switch(tagName){case"m":data.cursor.push({type:"cursor-movement",x:parseInt(item.attr("x")),y:parseInt(item.attr("y")),pressure:parseFloat(item.attr("p")),time:parseInt(item.attr("t"))});break;case"c":data.cursor.push({type:"color-change",color:item.attr("value")});break;case"s":data.cursor.push({type:"brush-size-change",size:parseInt(item.attr("value"))});break}});chunks.push(data)});return true};XmlReader.prototype.getNext=function(){if(chunks.length<=currentChunk){return undefined}if(chunks[currentChunk].cursor.length<=currentStep){currentStep=0;currentChunk++;if(chunks.length<=currentChunk){return undefined}}var chunk=chunks[currentChunk].cursor[currentStep++];return chunk};XmlReader.prototype.getPrerenderedData=function(from,to){};var rewind=function(){console.log("rewind");jumpTo(0,0)};var jumpTo=function(chunk,step){currentChunk=chunk;currentStep=step;VideoEvents.trigger("color-change",chunks[currentChunk].currentColor);VideoEvents.trigger("brush-size-change",chunks[currentChunk].currentBrushSize)};return XmlReader}();var XmlWriter=function(){var namespaces={xmlns:"http://www.rozsival.com/xml/khan-academy","xmlns:xsi":"http://www.w3.org/2001/XMLSchema-instance","xmlns:noNmespaceSchemaLocation":"vector-video.xsd"};var createRootElement=function(version){var attrs={version:version};for(var ns in namespaces){attrs[ns]=namespaces[ns]}var animation=HTML.createElement("animation",attrs);return animation};var createInfoElement=function(info,name){name=name||"info";var root=HTML.createElement(name);for(var item in info){if(Array.isArray(info[item])){root=[];for(var i in info[item]){root.push(createInfoElement(info[item][i],name))}}else if(typeof info[item]=="object"){var child=createInfoElement(info[item],item);if(Array.isArray(child)){for(var i in child){root.appendChild(child[i])}}else{root.appendChild(child)}}else{var el=HTML.createElement(item,name);el.textContent=info[item];root.appendChild(el)}}return root};var createDataElement=function(data){var dataEl=HTML.createElement("data");for(var i=0;i<data.length;i++){var chunk=HTML.createElement("chunk",{start:data[i].start,"current-color":data[i].color,"current-brush-size":data[i].size});var cursor=HTML.createElement("cursor");var cursorData=data[i].cursor;for(var j=0;j<cursorData.length;j++){var item=cursorData[j];switch(item.type){case"cursor-movement":var m=HTML.createElement("m",{x:item.x,y:item.y,p:item.pressure,t:item.time});cursor.appendChild(m);break;case"color-change":var c=HTML.createElement("c",{value:item.color});cursor.appendChild(c);break;case"brush-size-change":var s=HTML.createElement("s",{value:item.size});cursor.append(s);break}}chunk.appendChild(cursor);var svg=HTML.createElement("svg");chunk.appendChild(svg);dataEl.appendChild(chunk)}return dataEl};return{write:function(info,data){if(info==undefined||data==undefined){console.log("Nothing to save.");return}var rootEl=createRootElement("dev");var infoEl=createInfoElement(info);var dataEl=createDataElement(data);rootEl.appendChild(infoEl);rootEl.appendChild(dataEl);return rootEl}}}();var secondsToString=function(s){var seconds=Math.floor(s%60);if(seconds<=9){seconds="0"+seconds}var minutes=Math.floor(s/60);return minutes+":"+seconds};var millisecondsToString=function(ms){return secondsToString(Math.floor(ms/1e3))};var HTML={createElement:function(name,attributes,children){var el=document.createElement(name);HTML.setAttributes(el,attributes);if(!!children&&Array.isArray(children)){for(var i in children){el.appendChild(children[i])}}return el},setAttributes:function(el,attributes){for(var attr in attributes){el.setAttribute(attr,attributes[attr])}}};var Saver=function(){var saveBlob=function(blob,name){var a=$("<a>").hide();$("body").append(a);var url=URL.createObjectURL(blob);a.attr("href",url);a.attr("download",name);console.log(a);a[0].click();URL.revokeObjectURL(url)};return{saveWav:function(blob){saveBlob(blob,"recording.wav")},saveXml:function(text){var blob=new Blob([text],{type:"text/xml"});saveBlob(blob,"data.xml")}}}();var SplineHelper=function(){return{catmullRomToBezier:function(a,b,c,d){return{start:b,startCP:new Vector2(-1/6*a.getX()+b.getX()+1/6*c.getX(),-1/6*a.getY()+b.getY()+1/6*c.getY()),end:c,endCP:new Vector2(1/6*b.getX()+c.getX()+-1/6*d.getX(),1/6*b.getY()+c.getY()+-1/6*d.getY())}}}}();var State=function(){function State(x,y,pressure,time,type){if(typeof x==="object"){this.x=x.x;this.y=x.y;this.pressure=x.pressure;this.time=x.time;this.type=x.type}else{this.x=x;this.y=y;this.pressure=pressure;this.time=time;this.type=type}}return State}();var SVG={namespace:"http://www.w3.org/2000/svg",dot:function(center,radius,color){if(radius>0){return SVG.createElement("circle",{cx:center.getX(),cy:center.getY(),r:radius,fill:color,stroke:"transparent"})}return null},circle:function(center,radius,color){if(radius>0){return SVG.createElement("circle",{cx:center.getX(),cy:center.getY(),r:radius,stroke:color,fill:"transparent","stroke-width":1})}return null},line:function(start,end,width,color){if(width>0){return SVG.createElement("path",{fill:"transparent",stroke:color,"stroke-width":width,d:SVG.moveToString(start)+" "+SVG.lineToString(end)})}return null},createElement:function(name,attributes){var el=document.createElementNS(SVG.namespace,name);if(attributes){SVG.setAttributes(el,attributes)}return el},setAttributes:function(el,attributes){for(var attr in attributes){el.setAttributeNS(null,attr,attributes[attr])}},moveToString:function(a){return"M "+a.getX()+","+a.getY()},lineToString:function(a){return"L "+a.getX()+","+a.getY()},curveToString:function(a,b,c){return"C "+a.getX()+","+a.getY()+" "+b.getX()+","+b.getY()+" "+c.getX()+","+c.getY()}};var Vector2=function(){function Vector2(x,y){this.getX=function(){return x};this.getY=function(){return y}}Vector2.prototype.getSize=function(){return Math.sqrt(this.getX()*this.getX()+this.getY()*this.getY())};Vector2.prototype.distanceTo=function(b){return this.subtract(b).getSize()};Vector2.prototype.normalize=function(){var size=this.getSize();if(size===0){throw new Exception("Can't normalize zero vector.")}return this.scale(1/size)};Vector2.prototype.getNormal=function(){return new Vector2(-this.getY(),this.getX()).normalize()};Vector2.prototype.add=function(b){return new Vector2(this.getX()+b.getX(),this.getY()+b.getY())};Vector2.prototype.subtract=function(b){return new Vector2(this.getX()-b.getX(),this.getY()-b.getY())};Vector2.prototype.scale=function(c){return new Vector2(this.getX()*c,this.getY()*c)};Vector2.prototype.clone=function(){return new Vector2(this.getX(),this.getY())};return Vector2}();var VideoEvents=function(){var events={};var triggerAsync=function(event,i,_arguments){setTimeout(function(){events[event][i].apply(this,_arguments)},0)};return{trigger:function(event){if(events.hasOwnProperty(event)){for(var i=0;i<events[event].length;++i){triggerAsync.call(this,event,i,arguments)}}},on:function(event,callback){if(!events.hasOwnProperty(event)){events[event]=[]}events[event].push(callback)},off:function(event,callback){if(events.hasOwnProperty(event)){var index=events[event].indexOf(callback);if(index!==-1){events[event].splice(index,1)}}}}}();var VideoTimer=function(){function VideoTimer(){var clock;if(!window.performance){clock=Date}else{clock=window.performance}this.getClock=function(){return clock};var startTime;this.getStartTime=function(){return startTime};this.resetTimer=function(){startTime=clock.now()};this.setTime=function(ms){this.resetTimer();startTime+=ms};this.resetTimer()}VideoTimer.prototype.currentTime=function(){return this.getClock().now()-this.getStartTime()};return VideoTimer}();var Player=function(){var settings={xml:{file:""},container:{selector:"#player"},cursor:{size:20,color:"#fff"},audio:[],localization:{ui:{}}};function Player(options){$.extend(true,settings,options);var el=$(settings.container.selector);var ui=new PlayerUI({container:el,localization:settings.localization.ui});var settingsMonitor=new BasicSettings;var lineDrawer=new SVGDrawer(settingsMonitor);var dataProvider=new XmlDataProvider(options.xml.file);var audioPlayer=new AudioPlayer(dataProvider.getAudioSources())}return Player}();var Recorder=function(){var data=[];var chunk=null;var lastTime=0;var current={color:"#fff",size:3};var settings={chunkLength:2e3,container:{id:"recorder"},cursor:{},localization:{redirectPrompt:"Do you want to view your recorded video?",failureApology:"We are sorry, but your recording could not be uploaded to the server. Do you want to save the recorded data to your computer?",ui:{}},url:{saveResult:"",redirect:""},audio:{}};var ui;var audioRecorder;var state={recording:false};function Recorder(options){$.extend(true,settings,options);var el=document.getElementById(settings.container.id);bindEvents.call(this);state.recording=false;var dataProvider=new UserInputDataProvider;var settingsProvider=new BasicSettings;var lineDrawer=new SVGDrawer(settingsProvider);audioRecorder=new AudioRecorder(settings.audio);audioRecorder.init();ui=new RecorderUI({container:el,localization:settings.localization.ui})}var bindEvents=function(){VideoEvents.on("start",function(){addChunk(0);state.recording=true;audioRecorder.start()});VideoEvents.on("continue",function(){state.recording=true;if(audioRecorder){audioRecorder.continue()}});VideoEvents.on("pause",function(){state.recording=false;if(audioRecorder){audioRecorder.pause()}});VideoEvents.on("stop",function(e,params){state.recording=false;data.push(chunk);chunk=null;if(audioRecorder&&audioRecorder.isRecording()){audioRecorder.stop({success:function(files){params.audio=files;uploadData(params)},error:function(){finishRecording(false)}})}else{params.audio=[];uploadData(params)}});VideoEvents.on("new-state",function(e,movement){if(state.recording==true){movement.type="cursor-movement";addState(movement)}});VideoEvents.on("color-change",function(e,color){current.color=color;if(state.recording==true){addState({type:"color-change",color:color})}});VideoEvents.on("brush-size-change",function(e,size){current.size=size;if(state.recording==true){addState({type:"brush-size-change",size:size})}});VideoEvents.on("update-info",function(e,infoData){setInfoData(infoData)})};var addState=function(videoState){if(videoState.hasOwnProperty("time")){lastTime=videoState.time;if(chunk.start+settings.chunkLength<videoState.time){addChunk(videoState.time)}}chunk.cursor.push(videoState)};var addChunk=function(time){if(chunk!=null){data.push(chunk)}chunk={start:time-time%settings.chunkLength,color:current.color,size:current.size,cursor:[]}};var info={about:{author:"",title:"",description:""},length:0,chunkLength:2e3,chunksCount:0,board:{width:800,height:400,background:"#000"},audio:[]};var setInfoData=function(infoData){$.extend(true,info,infoData)};var uploadData=function(params){console.log("Uploading recorded data...");params=params||{};params.info=params.info||{};$.extend(true,info,params.info);info.length=lastTime;info.chunkLength=settings.chunkLength;info.chunksCount=data.length;info.board.width=ui.board.width();info.board.height=ui.board.height();info.board.background=ui.board.css("background");info.audio=params.audio||[];var animation=XmlWriter.write(info,data);var hack=document.createElement("hack");hack.appendChild(animation);var rawXml=hack.innerHTML;VideoEvents.on("save-data",function(){Saver.saveXml(rawXml)});var request={title:info.about.title,description:info.about.description,xml:rawXml,audio:params.audio};$.ajax({type:"POST",url:settings.url.saveResult,data:request,success:function(data){if(data.success===true){finishRecording(true,data.redirect)}else{console.log("Error: ",data.msg);finishRecording(false)}},error:function(e){alert("Could not save the data.");console.log("request error",e);finishRecording(false)}})};var finishRecording=function(success,url){VideoEvents.trigger("recording-finished");if(success===true){if(confirm(settings.localization.redirectPrompt)){window.location.replace(url)}}else{if(confirm(settings.localization.failureApology)){VideoEvents.trigger("save-data")}}};return Recorder}();var BasicSettings=function(){var settings={color:"",brushSize:0,correctionRatio:1};function BasicSettings(options){$.extend(true,settings,options);VideoEvents.on("new-board-correction-ratio",function(e,ratio){var originalSize=settings.brushSize/settings.correctionRatio;settings.brushSize=originalSize*ratio});VideoEvents.on("color-change",function(e,color){setColor(color)});VideoEvents.on("brush-size-change",function(e,size){setSize(size)})}var setColor=function(color){settings.color=color};var setSize=function(size){settings.brushSize=size};BasicSettings.prototype.getCurrentSettings=function(){return settings};return BasicSettings}();var DelayedInvokeQueue=function(){var worker;var queue=[];function DelayedInvokeQueue(){if(!!window.Worker&&false){worker=new Worker("delayed-invoke-worker.js")}else{worker=new DelayedInvokeWorkerMockup}worker.onmessage=receiveMessage}DelayedInvokeQueue.prototype.enqueue=function(callback,ms){queue.push(callback);worker.postMessage({time:ms})};var receiveMessage=function(){queue.shift().call()};return DelayedInvokeQueue}();var DelayedInvokeWorkerMockup=function(){function DelayedInvokeWorkerMockup(){this.onmessage=function(){}}DelayedInvokeWorkerMockup.prototype.postMessage=function(data){setTimeout(this.onmessage,data.time)};return DelayedInvokeWorkerMockup}();var isRunning=false;self.onmessage=function(data){queue.push(data.time);if(!isRunning){run()}};var run=function(){var queue=[];var timer=new VideoTimer;do{if(queue.length>0){var next=queue.shift();timer.resetTimer();while(timer.currentTime()<next){}self.postMessage()}}while(true)};var Cursor=function(){var settings={size:20,color:"#fff"};var offset=0;function Cursor(options){$.extend(true,settings,options);
this.element=UIFactory.createCursorCanvas.call(this,settings.size,settings.color);offset=settings.size/2;var _this=this;VideoEvents.on("new-state",function(e,state){if(state!=undefined){moveTo.call(_this,state.x,state.y)}})}var moveTo=function(x,y){this.element.style.left=x-offset+"px";this.element.style.top=y-offset+"px"};return Cursor}();var PlayerUI=function(){var state={playing:false,reachedEnd:false,progress:0,preloaded:0};var videoLength=0;var btn,icon;var bar,preloaded;var currentProgress,bufferedUntil;var progressTimeContainer;var board,canvas;var boardInfo={width:0,height:0};var settings={localization:{noJS:"Your browser does not support JavaScript or it is turned off. Video can't be played without enabled JavaScript in your browser.",play:"Play video",pause:"Pause video",replay:"Replay video",skip:"Skip to this point"},cursor:{},container:undefined,containerSelector:"#player"};function PlayerUI(options){$.extend(true,settings,options);var container=settings.container||$(settings.containerSelector);var _this=this;VideoEvents.on("data-ready",function(e,info){console.log(this);videoLength=info.length;var ratio=info.board.height/info.board.width;createBoard.call(this,container,ratio);_this.board=board;createControls.call(this,container);_this.canvas=canvas;var cursor=new Cursor(settings.cursor);board.append(cursor.element);console.log("UI for the player is ready");VideoEvents.trigger("ui-ready")})}var createBoard=function(container,aspectRatio){board=$("<div></div>").attr("id","board").css("width","100%");container.append(board);var width=parseInt(board.width());var height=aspectRatio*width;board.height(height);var canvasContainer=$("<div>");canvasContainer.attr("id","canvas-container");canvasContainer.attr("width",width).attr("height",height);board.append(canvasContainer).append("<noscript><p>"+ +"</p></noscript>");VideoEvents.trigger("board-dimensions",{width:width,height:height});VideoEvents.trigger("canvas-container-ready",canvasContainer)};var createControls=function(container){var buttonContainer=$("<div></div>").attr("id","button-container");preparePlayPauseButton.call(this,buttonContainer);var progressBarContainer=$("<div></div>").attr("id","progress-bar").addClass("progress");var progressContainer=$("<div></div>").attr("id","video-progress").append(progressBarContainer);prepareProgressBar.call(this,progressBarContainer);progressTimeContainer=$("<div></div>").attr("id","video-time");prepareProgressText.call(this,progressTimeContainer);var controls=$("<div></div>").attr("id","controls").append(buttonContainer).append(progressContainer).append(progressTimeContainer);container.append(controls)};var preparePlayPauseButton=function(container){btn=UIFactory.button("success").attr("title",settings.localization.play);icon=UIFactory.glyphicon("play");btn.append(icon);container.append(btn);var playPause=function(){if(state.playing==true){VideoEvents.trigger("pause");UIFactory.changeIcon(icon,"play");btn.attr("title",settings.localization.play)}else{if(state.reachedEnd==true){state.reachedEnd=false;VideoEvents.trigger("rewind")}VideoEvents.trigger("start");UIFactory.changeIcon(icon,"pause");btn.attr("title",settings.localization.pause)}state.playing=!state.playing};btn.on("click",playPause);var spacebar=32;$("body").on("keyup",function(e){if(e.keyCode==spacebar){playPause()}});VideoEvents.on("reached-end",function(){state.playing=false;state.reachedEnd=true;UIFactory.changeIcon(icon,"repeat");btn.attr("title",settings.localization.replay)})};var prepareProgressBar=function(container){bar=UIFactory.progressbar("success",0);bar.attr("title",settings.localization.skip);preloaded=UIFactory.progressbar("info",0);container.append(preloaded).append(bar);currentProgress=0;var skip=function(progress){UIFactory.changeProgress(bar,progress*100);if(state.reachedEnd&&progress<1){UIFactory.changeIcon(icon,"play");state.reachedEnd=false}};container.on("click",function(event){state.progress=(event.pageX-container.offset().left)/container.width();if(state.playing==true)VideoEvents.trigger("pause");VideoEvents.trigger("skip-to",state.progress);if(state.playing==true)VideoEvents.trigger("start");skip(state.progress)});VideoEvents.on("rewind",function(){last=0;status.reachedEnd=false;UIFactory.changeProgress(bar,0)});VideoEvents.on("skip-to",function(e,progress){status.reachedEnd=false;skip(progress)});var last=0;VideoEvents.on("next-state-peek",function(e,next){var step=next.time-last;last=next.time;currentProgress=next.time/videoLength*100;UIFactory.changeProgress(bar,currentProgress,step)});VideoEvents.on("buffered-until",function(e,time){time*=1e3;buffered=Math.ceil(time/videoLength*100);UIFactory.changeProgress(preloaded,buffered)})};var prepareProgressText=function(container){var text=$("<strong></strong>").addClass("time").attr("id","current-time").text(secondsToString(0));totalTime=$("<span></span>").addClass("time").attr("id","total-time").text(millisecondsToString(videoLength));container.append(text).append("<span>&nbsp;/&nbsp;</span>").append(totalTime);VideoEvents.on("current-time",function(e,time){text.text(secondsToString(time))})};return PlayerUI}();var RecorderUI=function(){var settings={pallete:{white:"#ffffff",yellow:"#fbff06",red:"#fa5959",green:"#8cfa59",blue:"#59a0fa"},widths:{narrow:5,normal:10,wide:15},"default":{color:"blue",size:"narrow"},cursor:{size:20,color:"#fff"},localization:{noJS:"Your browser does not support JavaScript or it is turned off. Video can't be recorded without enabled JavaScript in your browser.",record:"Record video",pause:"Pause recording",upload:"Upload",changeColor:"Change brush color",changeSize:"Change brush size",waitingText:"Please be patient. Uploading video usually takes some times - up to a few minutes if your video is over ten minutes long. Do not close this tab or browser window."},container:undefined,containerSelector:"#recorder"};var state={recording:false,paused:false};var btn,uploadBtn,modal,board,progressSpan;function RecorderUI(options){$.extend(true,settings,options);var container=settings.container;var board=createBoard.call(this,container);var controls=createControls.call(this,container);container.appendChild(controls);this.board.style.height="100%";container.insertBefore(board,container.firstChild);createCanvasContainer.call(this,this.board);VideoEvents.trigger("canvas-container-ready",this.canvas);var cursor=new Cursor(settings.cursor);this.board.appendChild(cursor.element);var modal=prepareUploadModal.call(this);container.appendChild(modal);var plugin=HTML.createElement("object",{id:"wtPlugin",type:"application/x-wacomtabletplugin"});document.body.appendChild(plugin);VideoEvents.trigger("wacom-plugin-ready",plugin)}var createBoard=function(){this.board=HTML.createElement("div",{id:"board"},[HTML.createElement("noscript",{},[function(){var p=HTML.createElement("p");p.innerHTML=settings.localization.noJS;return p}()])]);return this.board};var createCanvasContainer=function(board){this.canvas=HTML.createElement("div",{id:"canvas-container",width:board.outerWidth,height:board.outerHeight});this.board.appendChild(this.canvas)};var createControls=function(){var buttonContainer=HTML.createElement("div",{id:"rec-button-container"});prepareButtons.call(this,buttonContainer);var colorsPanel=HTML.createElement("div",{id:"colors-panel"});prepareColorsPanel(colorsPanel);var sizesPanel=HTML.createElement("div",{id:"brushes-panel"});prepareSizesPanel(sizesPanel);var controls=HTML.createElement("div",{id:"controls"},[buttonContainer,colorsPanel,sizesPanel]);return controls};var prepareButtons=function(container){btn=UIFactory.button("success");HTML.setAttributes(btn,{title:settings.localization.record});btn.innerHTML="REC";container.appendChild(btn);uploadBtn=UIFactory.button("default");HTML.setAttributes(uploadBtn,{disabled:"disabled",title:settings.localization.upload});uploadBtn.innerHTML=settings.localization.upload.toUpperCase();container.appendChild(uploadBtn);state.recording=false;var _this=this;btn.addEventListener("mouseup",function(e){e.preventDefault();if(state.recording===false){if(state.paused){continueRecording.call(_this)}else{start.call(_this)}state.paused=false;HTML.setAttributes(btn,{title:settings.localization.pause})}else{state.paused=true;pause.call(_this);HTML.setAttributes(btn,{title:settings.localization.record})}state.recording=!state.recording});uploadBtn.addEventListener("mouseup",function(e){e.preventDefault();var modal=document.getElementsByClassName("modal-bg");modal.className="modal-bg active"})};var tick;var start=function(){VideoEvents.trigger("start");recording.call(this)};var continueRecording=function(){VideoEvents.trigger("continue");recording.call(this)};var recording=function(){UIFactory.changeButton(btn,"danger");HTML.setAttributes(uploadBtn,{disabled:"disabled"});this.board.className+=" no-pointer";var time=0;tick=setInterval(function(){time+=1;btn.innerHTML=secondsToString(time)},1e3)};var pause=function(){UIFactory.changeButton(btn,"success");this.board.className.replace("no-pointer","");uploadBtn.removeAttribute("disabled");VideoEvents.trigger("pause");clearInterval(tick)};var prepareUploadModal=function(){var titleInput=HTML.createElement("input",{type:"text",name:"title",placeholder:"video's title","class":"form-control"});var authorInput=HTML.createElement("input",{type:"text",name:"author",placeholder:"your name","class":"form-control"});var descriptionTextarea=HTML.createElement("textarea",{name:"description",placeholder:"video description","class":"form-control"});var save=HTML.createElement("button",{type:"button","class":"btn btn-primary"});save.innerHTML="Save video";var infoAlert=HTML.createElement("p",{"class":"alert alert-info"});infoAlert.innerHTML=settings.localization.waitingText;var uploadInfo=HTML.createElement("div",{style:"display: none;"},[infoAlert]);VideoEvents.on("upload-progress",function(e,percent){console.log(percent)});var closeBtn=HTML.createElement("button",{"class":"close-btn"});closeBtn.innerHTML="&times";closeBtn.addEventListener("mouseup",function(e){e.preventDefault();var wrapper=document.getElementsByClassName("modal-bg");wrapper.className="";wrapper.className="modal-bg"});var title=HTML.createElement("h4");title.innerHTML="Save captured video";var modalBody=HTML.createElement("div",{"class":"modal-body"},[HTML.createElement("p",{"class":"form-group"},[titleInput]),HTML.createElement("p",{"class":"form-group"},[authorInput]),HTML.createElement("p",{"class":"form-group"},[descriptionTextarea]),uploadInfo]);var modalFooter=HTML.createElement("div",{"class":"modal-footer"},[closeBtn,save]);modal=HTML.createElement("div",{"class":"modal"},[closeBtn,title,modalBody,modalFooter]);save.addEventListener("mouseup",function(e){e.preventDefault();HTML.setAttributes(save,{disabled:"disabled"});save.innerHTML="Starting upload...";uploadInfo.slideToggle();VideoEvents.trigger("stop",{info:{about:{title:titleInput.val(),description:descriptionTextarea.val(),author:authorInput.val()}}})});VideoEvents.on("recording-finished",function(){save.innerHTML="Video was successfully uploaded."});return HTML.createElement("div",{"class":"modal-bg"},[modal])};var prepareColorsPanel=function(panel){var changeColor=function(button){var children=button.parentNode.childNodes;for(var i=0;i<children.length;++i){HTML.setAttributes(children[i],{"class":"option"})}HTML.setAttributes(button,{"class":"option active"});VideoEvents.trigger("color-change",button.getAttribute("data-color"))};Object.keys(settings.pallete).forEach(function(color){var button=addColorButton(panel,color,settings.pallete[color]);button.addEventListener("mouseup",function(e){e.preventDefault();changeColor(button)})})};var prepareSizesPanel=function(panel){var changeSize=function(button){var children=button.parentNode.childNodes;for(var i=0;i<children.length;++i){HTML.setAttributes(children[i],{"class":"option"})}HTML.setAttributes(button,{"class":"option active"});var size=button.firstChild.getAttribute("data-size");VideoEvents.trigger("brush-size-change",settings.widths[size])};Object.keys(settings.widths).forEach(function(size){var button=addSizeButton(panel,size,settings.widths[size]);HTML.setAttributes(button,{title:settings.localization.changeSize});button.addEventListener("mouseup",function(e){e.preventDefault();changeSize(button)})})};var addColorButton=function(panel,colorName,colorValue){var button=HTML.createElement("button",{"class":"option","data-color":colorValue,title:colorName,style:"background-color: "+colorValue});if(colorName==settings.default.color){VideoEvents.trigger("color-change",colorValue);HTML.setAttributes(button,{"class":"option active"})}panel.appendChild(button);return button};var addSizeButton=function(panel,sizeName,size){var dot=HTML.createElement("span",{"class":"dot","data-size":sizeName});var borderWidth=2;dot.style.borderWidth=borderWidth+"px";dot.style.borderRadius=size/2+"px";dot.style.width=size-2*borderWidth+"px";dot.style.height=size-2*borderWidth+"px";var button=HTML.createElement("button",{"class":"option",title:size},[dot]);if(sizeName==settings.default.size){VideoEvents.trigger("brush-size-change",size);HTML.setAttributes(button,{"class":"option active"})}panel.appendChild(button);return button};return RecorderUI}();var UIFactory={button:function(type){return HTML.createElement("button",{"class":"btn btn-"+type,"data-type":type})},changeButton:function(button,type){HTML.setAttributes(button,{"class":"btn btn-"+type,"data-type":type});return button},progressbar:function(type,initialProgress){return HTML.createElement("div",{"class":"progress-bar progress-bar-"+type,"data-progress":initialProgress,css:"width: "+initialProgress+"%",role:"progress-bar"})},changeProgress:function(bar,progress,time){var first=progress.innerHTML[0];if(first==="+"||first==="-"){var sign=first==="+"?1:-1;progress=Number(bar.getAttribute("data-progress"))+sign*Number(progress.substr(1))}bar.stop();if(time==undefined){bar.style.width=progress+"%"}else{bar.style.transitionDuration=time/1e3+"s";bar.style.width=progress+"%"}bar.setAttribute("data-progress",progress)},createCursorCanvas:function(size,color){var canvas=SVG.createElement("svg",{width:size,height:size});var offset=size/2;var path=SVG.createElement("path",{fill:"transparent",stroke:color,"stroke-width":size*.1,d:"M "+offset+",0 L "+offset+","+size+" M 0,"+offset+" L "+size+","+offset+" Z"});canvas.appendChild(path);canvas.style.position="absolute";canvas.style.background="transparent";return canvas}};