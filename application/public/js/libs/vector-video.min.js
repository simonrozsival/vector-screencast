/**
 * Khanova Škola - vektorové video
 *
 * [@todo project anotation]
 * 
 * @author:		Šimon Rozsíval (simon@rozsival.com)
 * @project:	Vector screencast for Khan Academy (Bachelor thesis)
 * @repository: http://github.com/rozsival/vector-video
 * @license:	MIT
 */

var AudioRecorder=function(navigator,window){var _this;var context;var input;var recording=false;var recordingWorkerPath="/js/workers/recording-worker.js";var recordingWorker=null;var initSuccessful=false;var doNotStartRecording=false;var settings={port:3e3,host:"http://localhost",path:"/upload/audio",error:function(){console.log("Error arguments: ",arguments)}};function AudioRecorder(config){$.extend(true,settings,config);recording=false;_this=this}AudioRecorder.prototype.init=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;context=new AudioContext;console.log("Audio context is set up.");window.URL=window.URL||window.webkitURL;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia){navigator.getUserMedia({video:false,audio:true},function(localMediaStream){if(doNotStartRecording===false){input=context.createMediaStreamSource(localMediaStream);console.log("Created media stream.");console.log("Input sample rate: "+input.context.sampleRate);var bufferSize=2048;var recorder=context.createScriptProcessor(bufferSize,1,1);recorder.onaudioprocess=processData;input.connect(recorder);recorder.connect(context.destination);initSuccessful=true;_this.createAudioProcessor("web-socket",{port:settings.port||4e3,host:settings.host||"localhost",path:settings.path||"/",success:function(){console.log("Audio recording is ready.")},error:function(msg){console.log(msg)}});if(settings.hasOwnProperty("success")){settings.success()}VideoEvents.trigger("register-tool","audio-recorder")}},function(err){if(err.name==="PermissionDeniedError"){console.log("User didn't allow microphone usage.")}console.log("Can't record audio",err);settings.error({code:0,message:"Can't record audio"})})}else{console.log("getUserMedia not supported by the browser");settings.error({code:0,message:"getUserMedia not supported by the browser"})}};AudioRecorder.prototype.createAudioProcessor=function(AudioProcessorType,cfg){if(Worker){recordingWorker=new Worker(recordingWorkerPath);recordingWorker.postMessage({cmd:"init",AudioProcessorType:AudioProcessorType||"web-sockets",port:cfg.port,host:cfg.host,path:cfg.path});if(cfg.hasOwnProperty("success")){cfg.success()}}else{console.log("ERROR - no workers support - non supported browser.");alert("Your browser doesn't support Web Workers technology, audio can't be recorded.")}};AudioRecorder.prototype.start=function(cfg){cfg=cfg||{};if(initSuccessful){if(!recordingWorker){if(cfg&&cfg.hasOwnProperty("error")){cfg.error({code:1,message:"No audio processor was set."})}return false}else{recording=true;return true}}else{doNotStartRecording=true;return false}};AudioRecorder.prototype.continue=function(cfg){cfg=cfg||{};if(initSuccessful){if(!recordingWorker){if(cfg&&cfg.hasOwnProperty("error")){cfg.error({code:1,message:"No audio processor was set."})}return false}else{recording=true;return true}}else{}return false};AudioRecorder.prototype.pause=function(cfg){cfg=cfg||{};if(initSuccessful){recording=false;return true}else{}return false};AudioRecorder.prototype.stop=function(cfg){cfg=cfg||{};if(initSuccessful){if(this.pause(cfg)){var oldSuccess=cfg.success||undefined;cfg.success=function(data){if(oldSuccess){oldSuccess(data)}VideoEvents.trigger("tool-finished","audio-recorder")};if(recordingWorker){recordingWorker.onmessage=function(e){var msg=e.data;if(!msg.hasOwnProperty("error")){console.log("Worker response is invalid (missing property 'error'",e.data);return}if(msg.error===true&&cfg.hasOwnProperty("error")){cfg.error({message:msg.message})}else if(msg.error===false&&cfg.hasOwnProperty("success")){cfg.success(msg.fileName)}};recordingWorker.postMessage({cmd:"finish"})}}}else{if(cfg.hasOwnProperty("error")){cfg.error()}}};AudioRecorder.prototype.isRecording=function(){return initSuccessful};var processData=function(data){if(recording===false){return}var left=data.inputBuffer.getChannelData(0);if(recordingWorker){recordingWorker.postMessage({cmd:"pushData",data:left})}};return AudioRecorder}(navigator,window);var AudioPlayer=function(){var playing,reachedEnd;var audio;var initSuccessful;function AudioPlayer(sources,events){audio=HTML.createElement("audio",{preload:"auto"});initSuccessful=false;if(audio.canPlayType==undefined){console.log("ERROR: browser does not support HTML5 audio");return}audio.autoplay=false;playing=false;reachedEnd=false;var canPlaySound=false;for(var source in sources){var contentType="audio/"+sources[source].type;if(!!audio.canPlayType(contentType)){var source=HTML.createElement("source",{type:contentType,src:sources[source].file});audio.appendChild($source);canPlaySound=true}}if(canPlaySound==true){initSuccessful=true;attachPrivateEvents.call(this);attachEvents.call(this,events);$("body").append($audio);console.log("Audio is available.")}else{console.log("Can't play any provided audio sources.")}}AudioPlayer.prototype.isReady=function(){return initSuccessful};var attachPrivateEvents=function(){audio.onended=function(){playing=false;reachedEnd=true;console.log("(audio reached end)")};audio.onpause=function(){if(playing){VideoEvents.trigger("pause")}};audio.ontimeupdate=function(e){reportCurrentTime()};VideoEvents.on("start",function(){play()});VideoEvents.on("pause",function(){pause()});VideoEvents.on("reached-end",function(){reachedEnd=true;pause()});VideoEvents.on("replay",function(){rewind();play()});VideoEvents.on("skip-to",function(e,progress){reachedEnd=false;changePosition(audio.duration*progress)});var lastEnd=null;var checkPreloaded=setInterval(function(){if(audio.canPlayThrough){clearInterval(checkPreloaded)}else{var end=audio.buffered.end(audio.buffered.length-1);if(end!==lastEnd){VideoEvents.trigger("buffered-until",end);lastEnd=end}}},1e3)};var attachEvents=function(events){events=events||[];for(var eventName in events){$audio.on(eventName,events[eventName])}};var play=function(){if(initSuccessful){if(reachedEnd==true){rewind()}audio.play()}};var pause=function(){if(initSuccessful){audio.pause()}};var rewind=function(){if(initSuccessful){audio.pause();audio.currentTime=0;reachedEnd=false}};var changePosition=function(seconds,callback){console.log("audio - change position to "+seconds+"s");audio.currentTime=seconds;$audio.on("canplay",callback)};var reportCurrentTime=function(){VideoEvents.trigger("current-time",$audio[0].currentTime)};return AudioPlayer}();var UserInputDataProvider=function(){var state={running:false,mouseDown:false};var offset;var cursor={x:0,y:0};var timer;var penApi=false;function UserInputDataProvider(){document.onmousemove=function(e){onMouseMove(e)};document.onmousedown=function(e){onMouseDown(e)};document.onmouseup=function(e){onMouseUp(e)};window.onblur=function(e){onMouseUp(e)};init()}var getCurrentCursorState=function(){return new State({x:cursor.x,y:cursor.y,pressure:getPressure(),time:timer.currentTime()})};var getPressure=function(){if(penApi&&penApi.pointerType==1){return penApi.pressure}else{return state.mouseDown?1:0}};var correctMouseCoords=function(e){if(e.pageX==undefined||e.pageY==undefined){console.log("Wrong 'correctMouseCoords' parameter. Event data required.")}return{x:e.pageX-offset.left,y:e.pageY-offset.top}};var init=function(){timer=new VideoTimer;VideoEvents.on("canvas-container-ready",function(e,canvasContainer){offset=canvasContainer.offset()});VideoEvents.on("start",start);VideoEvents.on("continue",start);VideoEvents.on("pause",pause);VideoEvents.on("stop",pause);VideoEvents.on("wacom-plugin-ready",function(e,$plugin){var plugin=$plugin[0];if(plugin.version!=undefined){console.log("Wacom tablet is connected and plugin installed. Plugin version is "+plugin.version+".");penApi=plugin.penAPI}})};var start=function(){state.running=true;timer.resetTimer()};var pause=function(){state.running=false};var reportAction=function(action){if(action!=undefined){VideoEvents.trigger("new-state",action)}};var onMouseMove=function(e){if(state.running){cursor=correctMouseCoords.call(this,e);var current=getCurrentCursorState();reportAction(current)}};var onMouseDown=function(e){if(state.running){state.mouseDown=true;reportAction(getCurrentCursorState())}};var onMouseUp=function(e){if(state.running){state.mouseDown=false;reportAction(getCurrentCursorState())}};return UserInputDataProvider}();var XmlDataProvider=function(){var videoInfo;var correctionRatio;var state={running:false,reachedEnd:false,current:undefined,last:undefined};var startTime;var timeout;function XmlDataProvider(fileName){var _this=this;videoInfo=new XmlReader({file:fileName,success:function(){initEvents.call(_this);VideoEvents.trigger("data-ready",getInfo());rewind()},error:function(msg){videoInfo=null;VideoEvents.trigger("error",msg)}});state.running=false}XmlDataProvider.prototype.getTitle=function(){if(videoInfo){return videoInfo.getInfo().about.title}return null};XmlDataProvider.prototype.getAuthor=function(){if(videoInfo){return videoInfo.getInfo().about.author}return null};XmlDataProvider.prototype.getDescription=function(){if(videoInfo){return videoInfo.getInfo().about.description}return null};XmlDataProvider.prototype.getAudioSources=function(){if(videoInfo){var sources=[];var audio=videoInfo.getInfo().about.audio;for(var i in audio){sources.push({file:audio[i],type:getType(audio[i])})}return sources}return null};var getType=function(fileName){return fileName.substr(fileName.length-3)};var initEvents=function(){VideoEvents.on("board-dimensions",function(e,size){correctionRatio=size.width/getInfo().board.width;VideoEvents.trigger("new-board-correction-ratio",correctionRatio)});VideoEvents.on("start",start);VideoEvents.on("continue",start);VideoEvents.on("pause",stop);VideoEvents.on("stop",stop);VideoEvents.on("rewind",rewind);var _this=this;VideoEvents.on("skip-to",function(e,progress){var time=progress*getInfo().length;if(time>state.current.time){skipForward.call(_this,time)}else{skipBackwards.call(_this,time)}})};var getNextCursorState=function(){var next=videoInfo.getNext();while(next!=undefined&&next.type!="cursor-movement"){switch(next.type){case"color-change":console.log("Change color to ",next.color);VideoEvents.trigger("color-change",next.color);break;case"brush-size-change":VideoEvents.trigger("brush-size-change",next.size);break}next=videoInfo.getNext()}if(next==undefined){next={time:getInfo().length,x:-1,y:-1,pressure:0};state.reachedEnd=true;stop()}state.last=state.current;state.current=correctCoords(next);return state.current};var correctCoords=function(state){return{x:state.x*correctionRatio,y:state.y*correctionRatio,pressure:state.pressure,time:state.time}};var getInfo=function(){return videoInfo.getInfo()};var rewind=function(){state.last={time:0};state.current=videoInfo.getNext();state.reachedEnd=false};var start=function(){startTime=Date.now();startTime-=state.last.time;state.running=true;tick()};var skipForward=function(time){tickUntil.call(this,time)};var skipBackwards=function(time){VideoEvents.trigger("rewind");tickUntil.call(this,time)};var tickUntil=function(time){getNextCursorState();while(state.current.time<time){VideoEvents.trigger("new-state",state.current);getNextCursorState()}};var debt=0;var tick=function(){getNextCursorState();if(state.running){VideoEvents.trigger("next-state-peek",state.current);var timeGap=state.current.time-(Date.now()-startTime)-debt;debt=0;if(timeGap>0){timeout=setTimeout(function(){VideoEvents.trigger("new-state",state.current);tick()},timeGap)}else{debt=timeGap;console.log("debt: ",debt);tick()}}};var stop=function(){clearTimeout(timeout);if(state.running==true){state.running=false;if(state.reachedEnd==true){VideoEvents.trigger("reached-end")}}};return XmlDataProvider}();var RoundedLines=function(){var canvas,context;var last={x:0,y:0,radius:0};var board={width:0,height:0};var settings;function RoundedLines(settingsObject){VideoEvents.on("canvas-container-ready",function(e,canvasContainer){canvas=document.createElement("canvas");canvasContainer.append($(canvas));context=canvas.getContext("2d");canvas.width=canvasContainer.width();canvas.height=canvasContainer.height()});settings=settingsObject;var _this=this;VideoEvents.on("rewind",function(){clearAll()});var lastState={x:this.x,y:this.y,pressure:this.pressure,inside:true};VideoEvents.on("new-state",function(e,state){if(state.pressure>0){if(lastState.pressure==0){startLine.call(_this,state.x,state.y,state.pressure)}else{continueLine.call(_this,state.x,state.y,state.pressure)}}else if(lastState.pressure>0){endLine.call(_this,state.x,state.y)}lastState=state});VideoEvents.on("skip-to",function(e,progress){})}var startLine=function(x,y,pressure){var radius=calculateRadius(pressure);drawDot(x,y,radius);last.x=x;last.y=y;last.radius=radius};var continueLine=function(x,y,pressure){var radius=calculateRadius(pressure);drawSegment.call(this,x,y,radius);last.x=x;last.y=y;last.radius=radius};var calculateRadius=function(pressure){return pressure*current().brushSize/2};var current=function(){return settings.getCurrentSettings()};var drawDot=function(x,y,radius){var c=context;c.fillStyle=current().color;c.beginPath();c.arc(x,y,radius,0,Math.PI*2,true);c.closePath();c.fill()};var drawSegment=function(x,y,radius){var c=context;var current=settings.getCurrentSettings();c.strokeStyle=current.color;c.beginPath();var points=calculatePathPoints(x,y,radius);var start=points.shift();c.moveTo(start.x,start.y);for(i in points){var point=points[i];c.lineTo(point.x,point.y)}c.closePath();c.fill();if(radius>1){drawDot(x,y,radius)}};var calculatePathPoints=function(x,y,radius){var normalVector={x:last.y-y,y:x-last.x};var norm=Math.sqrt(normalVector.x*normalVector.x+normalVector.y*normalVector.y);normalVector.x/=norm;normalVector.y/=norm;return[{x:last.x+normalVector.x*last.radius,y:last.y+normalVector.y*last.radius},{x:last.x-normalVector.x*last.radius,y:last.y-normalVector.y*last.radius},{x:x-normalVector.x*radius,y:y-normalVector.y*radius},{x:x+normalVector.x*radius,y:y+normalVector.y*radius}]};var endLine=function(x,y,pressure){lastNormalVector={x:0,y:0}};var clearAll=function(){context.clearRect(0,0,board.width,board.height)};return RoundedLines}();var SVGDrawer=function(){var _this;var paper;var start=null;var end=null;var startControlPoint=null;var lastState;var endDot;var isOnlyClick=false;var settings;var paths={a:"",b:""};var path;function SVGDrawer(settingsObject){_this=this;settings=settingsObject;VideoEvents.on("canvas-container-ready",setupCanvasContainer);VideoEvents.on("rewind",function(){});VideoEvents.on("new-state",processNewState);VideoEvents.on("skip-to",function(e,progress){})}var setupCanvasContainer=function(e,container){paper=SVG.createElement("svg",{width:container.width(),height:container.height()});container.get(0).appendChild(paper)};var processNewState=function(e,state){if(state.pressure>0){if(!lastState||lastState.pressure===0){startLine.call(_this,state.x,state.y,state.pressure)}else{continueLine.call(_this,state.x,state.y,state.pressure)}}else if(lastState&&lastState.pressure>0){endLine.call(_this,state.x,state.y)}lastState=state};var startLine=function(x,y,pressure){isOnlyClick=true;var radius=calculateRadius(pressure);var dot=SVG.dot(x,y,radius,current().color);paper.appendChild(dot);path=SVG.createElement("path",{fill:current().color,stroke:"transparent","stroke-linecap":"round","stroke-linejoin":"round"});paper.appendChild(path);paths.a="M "+x+","+y+" ";paths.b="L "+x+","+y;resetLastState(x,y)};var continueLine=function(x,y,pressure){var radius=calculateRadius(pressure);if(isOnlyClick){isOnlyClick=false;endDot=SVG.dot(x,y,radius,current().color);paper.appendChild(endDot)}drawSegment.call(this,x,y,radius)};var calculateRadius=function(pressure){return pressure*current().brushSize/2};var current=function(){return settings.getCurrentSettings()};var a=.3;var drawSegment=function(x,y,radius){var nextPoint=new Vector2(x,y);var direction=new Vector2(nextPoint.x-start.x,nextPoint.y-start.y);var normal=getScaledNormal(direction,radius);if(normal===null){return}var controlPoints=getControlPoints(start,end,nextPoint,a,normal);if(controlPoints!==false){paths.a+="C "+startControlPoint.pathA.x+","+startControlPoint.pathA.y+" "+controlPoints.a.pathA.x+","+controlPoints.a.pathA.y+" "+(end.x+normal.x)+","+(end.y+normal.y)+" ";paths.b="C "+controlPoints.a.pathB.x+","+controlPoints.a.pathB.y+" "+startControlPoint.pathB.x+","+startControlPoint.pathB.y+" "+(start.x-normal.x)+","+(start.y-normal.y)+" "+paths.b;startControlPoint=controlPoints.b}else{return}var cap="L "+(end.x-normal.x)+","+(end.y-normal.y)+" ";SVG.setAttributes(path,{d:paths.a+cap+paths.b});moveEndDot(end.x,end.y,radius);start=end;end=nextPoint};var getScaledNormal=function(direction,radius){try{var normal=direction.getNormal();normal.x*=radius;normal.y*=radius;return normal}catch(Exception){return new Vector2(0,0)}};var getControlPoints=function(a,b,c,t,n){var dist={ab:Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2)),bc:Math.sqrt(Math.pow(c.x-b.x,2)+Math.pow(c.y-b.y,2))};var fa=t*dist.ab/(dist.ab+dist.bc);var fb=t*dist.bc/(dist.ab+dist.bc);var cp={a:{x:b.x-fa*(c.x-a.x),y:b.y-fa*(c.y-a.y)},b:{x:b.x+fb*(c.x-a.x),y:b.y+fb*(c.y-a.y)}};return{a:{pathA:new Vector2(cp.a.x+n.x,cp.a.y+n.y),pathB:new Vector2(cp.a.x-n.x,cp.a.y-n.y)},b:{pathA:new Vector2(cp.b.x+n.x,cp.b.y+n.y),pathB:new Vector2(cp.b.x-n.x,cp.b.y-n.y)}}};var endLine=function(x,y){if(!isOnlyClick){var lastRadius=calculateRadius(lastState.pressure);drawSegment(end.x,end.y,lastRadius);moveEndDot(end.x,end.y,lastRadius)}paths.a=null;paths.b=null;resetLastState(x,y)};var moveEndDot=function(x,y,radius){SVG.setAttributes(endDot,{cx:x,cy:y,radius:radius})};var resetLastState=function(x,y){start=end=new Vector2(x,y);startControlPoint={pathA:start,pathB:start}};return SVGDrawer}();var SVG={namespace:"http://www.w3.org/2000/svg",dot:function(x,y,radius,color){if(radius>0){return SVG.createElement("circle",{cx:x,cy:y,r:radius,fill:color,stroke:"transparent"})}return null},circle:function(x,y,radius,color){if(radius>0){return SVG.createElement("circle",{cx:x,cy:y,r:radius,stroke:color,fill:"transparent","stroke-width":1})}return null},line:function(start,end,width,color){if(width>0){return SVG.createElement("path",{fill:"transparent",stroke:color,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":width,d:"M"+start.x+" "+start.y+" L"+end.x+" "+end.y})}return null},createElement:function(name,attributes){var el=document.createElementNS(SVG.namespace,name);SVG.setAttributes(el,attributes);return el},setAttributes:function(el,attributes){for(var attr in attributes){el.setAttributeNS(null,attr,attributes[attr])}}};var XmlReader=function(){var info;var chunks=[];var currentChunk,currentStep;var loadedSuccessfully=false;function XmlReader(opts){VideoEvents.on("rewind",function(){rewind()});loadFile(opts,function(){rewind()})}var loadFile=function(opts,callback){var reportError=console.log;if(opts.hasOwnProperty("error")&&typeof opts.error=="function"){var reportError=opts.error}$.ajax({type:"GET",url:opts.file,dataType:"xml",success:function(data){var $xml=$(data);if($xml.length==0){console.log("Document is not a well-formed XML document and the video can't be loaded nor played.");return null}if(checkVersion($xml)){if(loadData($xml)){console.log("Data was loaded successfully.");loadedSuccessfully=true;callback.call();if(opts.hasOwnProperty("success")&&typeof opts.success=="function"){opts.success.call()}}else{console.log("Could not load data from a valid document.");if(typeof reportError=="function"){reportError("An error occured while loading data.")}}}else{console.log("Document is not valid or the version of the document is unsupported.");if(typeof reportError=="function"){reportError("Could not open this document. It is damaged or the version of the document is not supported.")}}},fail:function(){console.log("Retrieving the file failed.");if(typeof reportError=="function"){reportError("Could not open the document.")}}})};XmlReader.prototype.isLoaded=function(){return loadedSuccessfully===true};var supportedVersion=function(){return"dev"};var checkVersion=function($xml){var attr=$xml.find("animation").attr("version");return attr==supportedVersion()};var xsdFile=function(){return"/xml/khan-academy/vector-video.xsd"};var validateXmlDocument=function(rawXml,validationFunction){if(typeof validationFunction=="function"){if(!validationFunction(rawXml,xsdFile())){console.log("Validation against an XSD document was requested and it failed.");return false}}return true};XmlReader.prototype.getInfo=function(){return info};var loadData=function($xml){var search=function(parent){var data={};parent.children().each(function(){var child=$(this);data[this.tagName]=child.children().length>0?search(child):child.text()});return data};info=search($xml.find("info"));$xml.find("chunk").each(function(){var chunk=$(this);var data={start:chunk.attr("start"),currentColor:chunk.attr("current-color"),currentBrushSize:chunk.attr("current-brush-size"),cursor:[],prerendered:chunk.children("svg")};chunk.children("cursor").children().each(function(){var tagName=this.tagName;var item=$(this);switch(tagName){case"m":data.cursor.push({type:"cursor-movement",x:parseInt(item.attr("x")),y:parseInt(item.attr("y")),pressure:parseFloat(item.attr("p")),time:parseInt(item.attr("t"))});break;case"c":data.cursor.push({type:"color-change",color:item.attr("value")});break;case"s":data.cursor.push({type:"brush-size-change",size:parseInt(item.attr("value"))});break}});chunks.push(data)});return true};XmlReader.prototype.getNext=function(){if(chunks.length<=currentChunk){return undefined}if(chunks[currentChunk].cursor.length<=currentStep){currentStep=0;currentChunk++;if(chunks.length<=currentChunk){return undefined}}var chunk=chunks[currentChunk].cursor[currentStep++];return chunk};XmlReader.prototype.getPrerenderedData=function(from,to){};var rewind=function(){console.log("rewind");jumpTo(0,0)};var jumpTo=function(chunk,step){currentChunk=chunk;currentStep=step;VideoEvents.trigger("color-change",chunks[currentChunk].currentColor);VideoEvents.trigger("brush-size-change",chunks[currentChunk].currentBrushSize)};return XmlReader}();var XmlWriter=function(){var namespaces={xmlns:"http://www.rozsival.com/xml/khan-academy","xmlns:xsi":"http://www.w3.org/2001/XMLSchema-instance","xmlns:noNmespaceSchemaLocation":"vector-video.xsd"};var createRootElement=function(version){var attrs={version:version};for(var ns in namespaces){attrs[ns]=namespaces[ns]}var animation=HTML.createElement("animation",attrs);return animation};var createInfoElement=function(info,name){name=name||"info";var root=HTML.createElement(name);for(var item in info){if(Array.isArray(info[item])){root=[];for(var i in info[item]){root.push(createInfoElement(info[item][i],name))}}else if(typeof info[item]=="object"){var child=createInfoElement(info[item],item);if(Array.isArray(child)){for(var i in child){root.appendChild(child[i])}}else{root.appendChild(child)}}else{var el=HTML.createElement(item,name);el.textContent=info[item];root.appendChild(el)}}return root};var createDataElement=function(data){var dataEl=HTML.createElement("data");for(var i=0;i<data.length;i++){var chunk=HTML.createElement("chunk",{start:data[i].start,"current-color":data[i].color,"current-brush-size":data[i].size});var cursor=HTML.createElement("cursor");var cursorData=data[i].cursor;for(var j=0;j<cursorData.length;j++){var item=cursorData[j];switch(item.type){case"cursor-movement":var m=HTML.createElement("m",{x:item.x,y:item.y,p:item.pressure,t:item.time});cursor.appendChild(m);break;case"color-change":var c=HTML.createElement("c",{value:item.color});cursor.appendChild(c);break;case"brush-size-change":var s=HTML.createElement("s",{value:item.size});cursor.append(s);break}}chunk.appendChild(cursor);var svg=HTML.createElement("svg");chunk.appendChild(svg);dataEl.appendChild(chunk)}return dataEl};return{write:function(info,data){if(info==undefined||data==undefined){console.log("Nothing to save.");return}var rootEl=createRootElement("dev");var infoEl=createInfoElement(info);var dataEl=createDataElement(data);rootEl.appendChild(infoEl);rootEl.appendChild(dataEl);return rootEl}}}();var Dimensions=function(){function Dimensions(width,height){if(typeof width==="object"){this.width=width.width;this.height=width.height}else{this.width=width;this.height=height}}return Dimensions}();var secondsToString=function(s){var seconds=Math.floor(s%60);if(seconds<=9){seconds="0"+seconds}var minutes=Math.floor(s/60);return minutes+":"+seconds};var millisecondsToString=function(ms){return secondsToString(Math.floor(ms/1e3))};var HTML={createElement:function(name,attributes){var el=document.createElement(name);HTML.setAttributes(el,attributes);return el},setAttributes:function(el,attributes){for(var attr in attributes){el.setAttribute(attr,attributes[attr])}}};var Saver=function(){var saveBlob=function(blob,name){var a=$("<a>").hide();$("body").append(a);var url=URL.createObjectURL(blob);a.attr("href",url);a.attr("download",name);console.log(a);a[0].click();URL.revokeObjectURL(url)};return{saveWav:function(blob){saveBlob(blob,"recording.wav")},saveXml:function(text){var blob=new Blob([text],{type:"text/xml"});saveBlob(blob,"data.xml")}}}();var State=function(){function State(x,y,pressure,time,type){if(typeof x==="object"){this.x=x.x;this.y=x.y;this.pressure=x.pressure;this.time=x.time;this.type=x.type}else{this.x=x;this.y=y;this.pressure=pressure;this.time=time;this.type=type}}return State}();var Vector2=function(){function Vector2(x,y){this.x=x;this.y=y}Vector2.prototype.getSize=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vector2.prototype.normalize=function(){var size=this.getSize();if(size===0){throw new Exception("Can't normalize zero vector.")}this.x/=size;this.y/=size};Vector2.prototype.getNormal=function(){var n=new Vector2(-this.y,this.x);n.normalize();return n};return Vector2}();var VideoEvents=function(){var events={};return{trigger:function(event){e=events[event]||false;if(e!==false){for(var e in events[event]){events[event][e].apply(this,arguments)}}},on:function(event,callback){if(!events.hasOwnProperty(event)){events[event]=[]}events[event].push(callback)}}}();var VideoTimer=function(){var startTime;function VideoTimer(){this.resetTimer()}VideoTimer.prototype.resetTimer=function(){startTime=0;startTime=this.currentTime()};VideoTimer.prototype.setTime=function(ms){this.resetTimer();startTime+=ms};VideoTimer.prototype.currentTime=function(){return(new Date).getTime()-startTime};return VideoTimer}();var Player=function(){var settings={xml:{file:""},container:{selector:"#player"},cursor:{size:20,color:"#fff"},audio:[],localization:{ui:{}}};function Player(options){$.extend(true,settings,options);var el=$(settings.container.selector);var ui=new PlayerUI({container:el,localization:settings.localization.ui});var settingsMonitor=new BasicSettings;var lineDrawer=new SVGDrawer(settingsMonitor);var dataProvider=new XmlDataProvider(options.xml.file);var audioPlayer=new AudioPlayer(dataProvider.getAudioSources())}return Player}();var Recorder=function(){var data=[];var chunk=null;var lastTime=0;var current={color:"#fff",size:3};var settings={chunkLength:2e3,container:{selector:"#recorder"},cursor:{},localization:{redirectPrompt:"Do you want to view your recorded video?",failureApology:"We are sorry, but your recording could not be uploaded to the server. Do you want to save the recorded data to your computer?",ui:{}},url:{saveResult:"",redirect:""},audio:{}};var ui;var audioRecorder;var state={recording:false};function Recorder(options){$.extend(true,settings,options);var el=$(settings.container.selector);bindEvents.call(this);state.recording=false;var dataProvider=new UserInputDataProvider;var settingsProvider=new BasicSettings;var lineDrawer=new SVGDrawer(settingsProvider);audioRecorder=new AudioRecorder(settings.audio);audioRecorder.init();ui=new RecorderUI({container:el,localization:settings.localization.ui})}var bindEvents=function(){VideoEvents.on("start",function(){addChunk(0);state.recording=true;audioRecorder.start()});VideoEvents.on("continue",function(){state.recording=true;if(audioRecorder){audioRecorder.continue()}});VideoEvents.on("pause",function(){state.recording=false;if(audioRecorder){audioRecorder.pause()}});VideoEvents.on("stop",function(e,params){state.recording=false;data.push(chunk);chunk=null;if(audioRecorder&&audioRecorder.isRecording()){audioRecorder.stop({success:function(files){params.audio=files;uploadData(params)},error:function(){finishRecording(false)}})}else{params.audio=[];uploadData(params)}});VideoEvents.on("new-state",function(e,movement){if(state.recording==true){movement.type="cursor-movement";addState(movement)}});VideoEvents.on("color-change",function(e,color){current.color=color;if(state.recording==true){addState({type:"color-change",color:color})}});VideoEvents.on("brush-size-change",function(e,size){current.size=size;if(state.recording==true){addState({type:"brush-size-change",size:size})}});VideoEvents.on("update-info",function(e,infoData){setInfoData(infoData)})};var addState=function(videoState){if(videoState.hasOwnProperty("time")){lastTime=videoState.time;if(chunk.start+settings.chunkLength<videoState.time){addChunk(videoState.time)}}chunk.cursor.push(videoState)};var addChunk=function(time){if(chunk!=null){data.push(chunk)}chunk={start:time-time%settings.chunkLength,color:current.color,size:current.size,cursor:[]}};var info={about:{author:"",title:"",description:""},length:0,chunkLength:2e3,chunksCount:0,board:{width:800,height:400,background:"#000"},audio:[]};var setInfoData=function(infoData){$.extend(true,info,infoData)};var uploadData=function(params){console.log("Uploading recorded data...");params=params||{};params.info=params.info||{};$.extend(true,info,params.info);info.length=lastTime;info.chunkLength=settings.chunkLength;info.chunksCount=data.length;info.board.width=ui.board.width();info.board.height=ui.board.height();info.board.background=ui.board.css("background");info.audio=params.audio||[];var animation=XmlWriter.write(info,data);var hack=document.createElement("hack");hack.appendChild(animation);var rawXml=hack.innerHTML;VideoEvents.on("save-data",function(){Saver.saveXml(rawXml)});var request={title:info.about.title,description:info.about.description,xml:rawXml,audio:params.audio};$.ajax({type:"POST",url:settings.url.saveResult,data:request,success:function(data){if(data.success===true){finishRecording(true,data.redirect)}else{console.log("Error: ",data.msg);finishRecording(false)}},error:function(e){alert("Could not save the data.");console.log("request error",e);finishRecording(false)}})};var finishRecording=function(success,url){VideoEvents.trigger("recording-finished");if(success===true){if(confirm(settings.localization.redirectPrompt)){window.location.replace(url)}}else{if(confirm(settings.localization.failureApology)){VideoEvents.trigger("save-data")}}};return Recorder}();var BasicSettings=function(){var settings={color:"",brushSize:0,correctionRatio:1};function BasicSettings(options){$.extend(true,settings,options);VideoEvents.on("new-board-correction-ratio",function(e,ratio){var originalSize=settings.brushSize/settings.correctionRatio;settings.brushSize=originalSize*ratio});VideoEvents.on("color-change",function(e,color){setColor(color)});VideoEvents.on("brush-size-change",function(e,size){setSize(size)})}var setColor=function(color){settings.color=color};var setSize=function(size){settings.brushSize=size};BasicSettings.prototype.getCurrentSettings=function(){return settings};return BasicSettings}();var Cursor=function(){var settings={size:20,color:"#fff"};var offset=0;function Cursor(options){$.extend(true,settings,options);this.element=UIFactory.createCursorCanvas.call(this,settings.size,settings.color);offset=settings.size/2;var _this=this;VideoEvents.on("new-state",function(e,state){if(state!=undefined){moveTo.call(_this,state.x,state.y)}})}var moveTo=function(x,y){this.element.style.left=x-offset+"px";
this.element.style.top=y-offset+"px"};return Cursor}();var PlayerUI=function(){var state={playing:false,reachedEnd:false,progress:0,preloaded:0};var videoLength=0;var btn,icon;var bar,preloaded;var currentProgress,bufferedUntil;var progressTimeContainer;var board,canvas;var boardInfo={width:0,height:0};var settings={localization:{noJS:"Your browser does not support JavaScript or it is turned off. Video can't be played without enabled JavaScript in your browser.",play:"Play video",pause:"Pause video",replay:"Replay video",skip:"Skip to this point"},cursor:{},container:undefined,containerSelector:"#player"};function PlayerUI(options){$.extend(true,settings,options);var container=settings.container||$(settings.containerSelector);var _this=this;VideoEvents.on("data-ready",function(e,info){console.log(this);videoLength=info.length;var ratio=info.board.height/info.board.width;createBoard.call(this,container,ratio);_this.board=board;createControls.call(this,container);_this.canvas=canvas;var cursor=new Cursor(settings.cursor);board.append(cursor.element);console.log("UI for the player is ready");VideoEvents.trigger("ui-ready")})}var createBoard=function(container,aspectRatio){board=$("<div></div>").attr("id","board").css("width","100%");container.append(board);var width=parseInt(board.width());var height=aspectRatio*width;board.height(height);var canvasContainer=$("<div>");canvasContainer.attr("id","canvas-container");canvasContainer.attr("width",width).attr("height",height);board.append(canvasContainer).append("<noscript><p>"+ +"</p></noscript>");VideoEvents.trigger("board-dimensions",{width:width,height:height});VideoEvents.trigger("canvas-container-ready",canvasContainer)};var createControls=function(container){var buttonContainer=$("<div></div>").attr("id","button-container");preparePlayPauseButton.call(this,buttonContainer);var progressBarContainer=$("<div></div>").attr("id","progress-bar").addClass("progress");var progressContainer=$("<div></div>").attr("id","video-progress").append(progressBarContainer);prepareProgressBar.call(this,progressBarContainer);progressTimeContainer=$("<div></div>").attr("id","video-time");prepareProgressText.call(this,progressTimeContainer);var controls=$("<div></div>").attr("id","controls").append(buttonContainer).append(progressContainer).append(progressTimeContainer);container.append(controls)};var preparePlayPauseButton=function(container){btn=UIFactory.button("success").attr("title",settings.localization.play);icon=UIFactory.glyphicon("play");btn.append(icon);container.append(btn);var playPause=function(){if(state.playing==true){VideoEvents.trigger("pause");UIFactory.changeIcon(icon,"play");btn.attr("title",settings.localization.play)}else{if(state.reachedEnd==true){state.reachedEnd=false;VideoEvents.trigger("rewind")}VideoEvents.trigger("start");UIFactory.changeIcon(icon,"pause");btn.attr("title",settings.localization.pause)}state.playing=!state.playing};btn.on("click",playPause);var spacebar=32;$("body").on("keyup",function(e){if(e.keyCode==spacebar){playPause()}});VideoEvents.on("reached-end",function(){state.playing=false;state.reachedEnd=true;UIFactory.changeIcon(icon,"repeat");btn.attr("title",settings.localization.replay)})};var prepareProgressBar=function(container){bar=UIFactory.progressbar("success",0);bar.attr("title",settings.localization.skip);preloaded=UIFactory.progressbar("info",0);container.append(preloaded).append(bar);currentProgress=0;var skip=function(progress){UIFactory.changeProgress(bar,progress*100);if(state.reachedEnd&&progress<1){UIFactory.changeIcon(icon,"play");state.reachedEnd=false}};container.on("click",function(event){state.progress=(event.pageX-container.offset().left)/container.width();if(state.playing==true)VideoEvents.trigger("pause");VideoEvents.trigger("skip-to",state.progress);if(state.playing==true)VideoEvents.trigger("start");skip(state.progress)});VideoEvents.on("rewind",function(){last=0;status.reachedEnd=false;UIFactory.changeProgress(bar,0)});VideoEvents.on("skip-to",function(e,progress){status.reachedEnd=false;skip(progress)});var last=0;VideoEvents.on("next-state-peek",function(e,next){var step=next.time-last;last=next.time;currentProgress=next.time/videoLength*100;UIFactory.changeProgress(bar,currentProgress,step)});VideoEvents.on("buffered-until",function(e,time){time*=1e3;buffered=Math.ceil(time/videoLength*100);UIFactory.changeProgress(preloaded,buffered)})};var prepareProgressText=function(container){var text=$("<strong></strong>").addClass("time").attr("id","current-time").text(secondsToString(0));totalTime=$("<span></span>").addClass("time").attr("id","total-time").text(millisecondsToString(videoLength));container.append(text).append("<span>&nbsp;/&nbsp;</span>").append(totalTime);VideoEvents.on("current-time",function(e,time){text.text(secondsToString(time))})};return PlayerUI}();var RecorderUI=function(){var settings={pallete:{white:"#ffffff",yellow:"#fbff06",red:"#fa5959",green:"#8cfa59",blue:"#59a0fa"},widths:{narrow:5,normal:10,wide:15},"default":{color:"blue",size:"narrow"},cursor:{size:20,color:"#fff"},localization:{noJS:"Your browser does not support JavaScript or it is turned off. Video can't be recorded without enabled JavaScript in your browser.",record:"Record video",pause:"Pause recording",upload:"Upload",changeColor:"Change brush color",changeSize:"Change brush size",waitingText:"Please be patient. Converting and uploading video usualy takes some times - up to a few minutes if your video is over ten minutes long. Do not close this tab or browser window."},container:undefined,containerSelector:"#recorder"};var state={recording:false,paused:false};var btn,uploadBtn,modal,board,progress;function RecorderUI(options){$.extend(true,settings,options);var container=settings.container||$(settings.containerSelector);var board=createBoard.call(this,container);var controls=createControls.call(this,container);container.append(controls);this.board.css("height","100%");container.prepend(board);createCanvasContainer.call(this,this.board);VideoEvents.trigger("canvas-container-ready",this.canvas);var cursor=new Cursor(settings.cursor);this.board.append(cursor.element);prepareUploadModal.call(this);var plugin=$("<object></object>").attr("id","wtPlugin").attr("type","application/x-wacomtabletplugin");$("body").append(plugin);VideoEvents.trigger("wacom-plugin-ready",plugin)}var createBoard=function(){this.board=$("<div></div>").attr("id","board").append("<noscript><p>"+settings.localization.noJS+"</p></noscript>");return this.board};var createCanvasContainer=function(board){this.canvas=$("<div>").attr("id","canvas-container").attr("width",board.width()).attr("height",board.height());this.board.append(this.canvas)};var createControls=function(){var buttonContainer=$("<div></div>").attr("id","rec-button-container");prepareButtons.call(this,buttonContainer);colorsPanel=$("<div></div>").attr("id","colors-panel");prepareColorsPanel(colorsPanel);sizesPanel=$("<div></div>").attr("id","brushes-panel");prepareSizesPanel(sizesPanel);var controls=$("<div></div>").attr("id","controls").append(buttonContainer).append(colorsPanel).append(sizesPanel);return controls};var prepareButtons=function(container){btn=UIFactory.button("success").attr("title",settings.localization.record);progressSpan=$("<span></span>").text("REC");var glyphicon=UIFactory.glyphicon("record");btn.append(glyphicon).append(progressSpan);container.append(btn);uploadBtn=UIFactory.button("default").attr("disabled","disabled").attr("title",settings.localization.upload);var uploadIcon=UIFactory.glyphicon("upload");uploadBtn.append(uploadIcon).append("<span>"+settings.localization.upload.toUpperCase()+"</span>");container.append(uploadBtn);state.recording=false;var _this=this;btn.on("click",function(e){e.preventDefault();if(state.recording===false){if(state.paused){continueRecording.call(_this)}else{start.call(_this)}state.paused=false;btn.attr("title",settings.localization.pause)}else{state.paused=true;pause.call(_this);btn.attr("title",settings.localization.record)}state.recording=!state.recording});uploadBtn.on("click",function(e){e.preventDefault();modal.modal()})};var tick;var start=function(){VideoEvents.trigger("start");recording.call(this)};var continueRecording=function(){VideoEvents.trigger("continue");recording.call(this)};var recording=function(){UIFactory.changeButton(btn,"danger");uploadBtn.attr("disabled","disabled");this.board.addClass("no-pointer");var time=0;tick=setInterval(function(){time+=1;progressSpan.text(secondsToString(time))},1e3)};var pause=function(){UIFactory.changeButton(btn,"success");this.board.removeClass("no-pointer");uploadBtn.removeAttr("disabled");VideoEvents.trigger("pause");clearInterval(tick)};var prepareUploadModal=function(){var titleInput=$("<input>").attr("type","text").attr("name","title").attr("placeholder","video's title").addClass("form-control");var authorInput=$("<input>").attr("type","text").attr("name","author").attr("placeholder","your name").addClass("form-control");var descriptionTextarea=$("<textarea />").attr("name","description").attr("placeholder","video description").addClass("form-control");var save=$("<button>").attr("type","button").addClass("btn btn-primary").text("Save video");var uploadInfo=$("<div />").css("display","none").append("<p />").addClass("alert alert-info").text(settings.localization.waitingText);var uploadBar=UIFactory.progressbar("info",0).text("0% uploaded").addClass("active progress-striped");var uploadProgress=$("<div />").addClass("progress").append(uploadBar).css("display","none");VideoEvents.on("upload-progress",function(e,percent){console.log(percent);UIFactory.changeProgress(uploadBar,percent);uploadBar.text(Math.floor(percent)+"% uploaded")});modal=$("<div />").addClass("modal fade").append($("<div />").addClass("modal-dialog").append($("<div />").addClass("modal-content").append($("<div />").addClass("modal-header").append($("<button>").attr("type","button").addClass("close").attr("data-dismiss","modal").append($("<span>").attr("aria-hidden","true").html("&times;")).append($("<span>").addClass("sr-only").text("Close"))).append($("<h4>Save captured video</h4>").addClass("modal-title"))).append($("<div />").addClass("modal-body").append($("<p />").addClass("form-group").append(titleInput)).append($("<p />").addClass("form-group").append(authorInput)).append($("<p />").addClass("form-group").append(descriptionTextarea)).append(uploadInfo).append(uploadProgress)).append($("<div />").addClass("modal-footer").append($("<button>").attr("type","button").addClass("btn btn-default").attr("data-dismiss","modal").text("Close")).append(save))));$("body").append(modal);save.on("click",function(e){e.preventDefault();$(this).attr("disabled","disabled");$(this).text("Started uploading...");uploadInfo.slideToggle();uploadProgress.slideToggle();VideoEvents.trigger("stop",{info:{about:{title:titleInput.val(),description:descriptionTextarea.val(),author:authorInput.val()}}})});VideoEvents.on("recording-finished",function(){save.text("Video was successfully uploaded.")})};var prepareColorsPanel=function(panel){var changeColor=function(button){button.addClass("active").siblings().removeClass("active");VideoEvents.trigger("color-change",button.data("color"))};Object.keys(settings.pallete).forEach(function(color){var button=addColorButton(panel,color,settings.pallete[color]);button.on("click",function(e){e.preventDefault();var btn=$(this);changeColor(btn)})})};var prepareSizesPanel=function(panel){var changeSize=function(button){button.addClass("active").siblings().removeClass("active");var size=button.children(".dot").data("size");VideoEvents.trigger("brush-size-change",settings.widths[size])};Object.keys(settings.widths).forEach(function(size){var button=addSizeButton(panel,size,settings.widths[size]).attr("title",settings.localization.changeSize);button.on("click",function(e){e.preventDefault();changeSize($(this))})})};var addColorButton=function(panel,colorName,colorValue){var button=$("<button></button>").addClass("option").data("color",colorValue).css("background-color",colorValue).attr("title",colorName);if(colorName==settings.default.color){VideoEvents.trigger("color-change",colorValue);button.addClass("active")}panel.append(button);return button};var addSizeButton=function(panel,sizeName,size){var dot=$("<span></span>").addClass("dot").data("size",sizeName).width(size).height(size).css("border-radius",size/2+"px");var button=$("<button></button>").addClass("option").attr("title",size).append(dot);if(sizeName==settings.default.size){VideoEvents.trigger("brush-size-change",size);button.addClass("active")}panel.append(button);return button};return RecorderUI}();var UIFactory={glyphicon:function(type){return $("<span></span>").addClass("glyphicon glyphicon-"+type).attr("data-icon-type",type)},changeIcon:function(icon,type){var old=icon.data("icon-type");icon.removeClass("glyphicon-"+old).addClass("glyphicon-"+type).data("icon-type",type)},button:function(type){return $("<button></button>").addClass("btn btn-"+type).data("type",type)},changeButton:function(button,type){return button.removeClass("btn-"+button.data("type")).addClass("btn-"+type).data("type",type)},progressbar:function(type,initialProgress){return $("<div></div>").addClass("progress-bar progress-bar-"+type).attr("role","progress-bar").data("progress",initialProgress).css("width",initialProgress+"%")},changeProgress:function(bar,progress,time){var first=progress.toString()[0];if(first=="+"||first=="-"){var sign=first=="+"?1:-1;progress=Number(bar.data("progress"))+sign*number(progress.substr(1))}bar.stop();if(time==undefined){bar.css("width",progress+"%")}else{bar.animate({width:progress+"%"},time,"linear")}bar.data("progress",progress)},createCursorCanvas:function(size,color){var canvas=document.createElement("canvas");canvas.width=size;canvas.height=size;var context=canvas.getContext("2d");var offset=size/2;context.lineWidth=size*.1;context.strokeStyle=color;context.beginPath();context.moveTo(offset,0);context.lineTo(offset,size);context.moveTo(0,offset);context.lineTo(size,offset);context.stroke();context.closePath();canvas.style.position="absolute";canvas.style.background="transparent";return canvas}};